name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy

      - name: Run Ruff
        run: ruff check scripts/ dashboards/

      - name: Run Black (check)
        run: black --check scripts/ dashboards/

      - name: Run MyPy
        run: mypy scripts/ --ignore-missing-imports

  test:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest
        run: pytest tests/ -v --cov=scripts --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  dbt:
    name: dbt Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-duckdb

      - name: Generate test data
        run: |
          pip install pandas numpy faker pyarrow pydantic duckdb
          python scripts/generate_events.py --events 10000 --days 7 --seed 42

      - name: Install dbt packages
        working-directory: dbt_project
        run: dbt deps

      - name: Run dbt debug
        working-directory: dbt_project
        run: dbt debug

      - name: Run dbt build
        working-directory: dbt_project
        run: dbt build --select staging intermediate

      - name: Run dbt test
        working-directory: dbt_project
        run: dbt test

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, dbt]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Check package
        run: |
          pip install twine
          twine check dist/*

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run full pipeline
        run: |
          # Generate data
          python scripts/generate_events.py --events 50000 --days 14 --seed 42

          # Run ETL
          python scripts/etl_pipeline.py

          # Verify outputs
          python -c "
          import pandas as pd
          from pathlib import Path

          processed_dir = Path('data/processed')
          assert processed_dir.exists(), 'Processed directory not found'

          files = list(processed_dir.glob('*.parquet'))
          assert len(files) > 0, 'No output files generated'

          for f in files:
              df = pd.read_parquet(f)
              print(f'{f.name}: {len(df):,} rows')
              assert len(df) > 0, f'Empty file: {f.name}'

          print('Integration test passed!')
          "
